# Stop Kubernetes man in the middle (CVE-2020-8554)

This policy aims to block attempts to exploit CVE-2020-8554.

## About the CVE

A new security issue was discovered in all Kubernetes versions that enables an attacker to intercept traffic from other pods (or nodes) in the cluster if the attacker can edit the service status.

This vulnerability (disclosed on December 8, 2020) unfolds a design flaw that affects all Kubernetes versions, and at this point does not have a software update that mitigates this issue. Users are advised to implement fine-grained access restrictions and can use RBAC policies and admission controllers such as this policy.

This policy is inspired by a detailed demonstration of the attack released by its reporter [here](https://blog.champtar.fr/K8S_MITM_LoadBalancer_ExternalIPs/).

## How to use

1. To match update requests for `status` subresources, update gatekeeper `ValidatingWebhookConfiguration` like following :

```
  rules:
  - apiGroups:
    - '*'
    apiVersions:
    - '*'
    operations:
    - CREATE
    - UPDATE
    resources:
    - '*/*'
```

2. Create the template: `kubectl apply -f template.yaml`
3. Create the constraint: `kubectl apply -f constraint.yaml`


## Test policy

1. Create a loadbalancer service (You must have a loadbalancer installed. Use a managed k8s service or install [metallb](https://metallb.universe.tf/installation/) for baremetal clusters). You can find a service example in `samples`.

```
kubectl apply -f mitm-svc.yaml
```

2. Start a proxy server for k8s API:

```
kubectl proxy &
```

3. Try to patch the status of the service:

```
curl -k -v -XPATCH  -H "Accept: application/json" -H "Content-Type: application/merge-patch+json" 'http://127.0.0.1:8001/api/v1/namespaces/default/services/mitm-lb/status' -d '{"status":{"loadBalancer":{"ingress":[{"ip": "1.1.1.1"}]}}}'
```